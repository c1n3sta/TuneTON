# Telegram Authentication Security Implementation

This document details the security enhancements implemented for the Telegram authentication pipeline in TuneTON.

## Overview

The Telegram authentication system in TuneTON has been enhanced with several security measures to ensure the integrity and authenticity of user authentication requests.

## Security Enhancements

### 1. Telegram Data Verification

The system now implements proper verification of Telegram WebApp data using HMAC-SHA256 hash validation:

1. **Hash Validation**: The system validates the `hash` parameter in Telegram's initData to ensure it was generated by Telegram
2. **Bot Token Verification**: Uses the Telegram bot token to create a secret key for hash verification
3. **Data Integrity Check**: Verifies that all initData parameters have not been tampered with
4. **Timestamp Validation**: Ensures the auth_date is recent (within 1 hour) to prevent replay attacks

### 2. Implementation Details

#### Client-Side (src/utils/telegramAuth.ts)

```typescript
export async function verifyTelegramData(initData: string, botToken: string): Promise<boolean> {
  try {
    const params = new URLSearchParams(initData);
    const hash = params.get('hash');
    const authDate = params.get('auth_date');
    
    // Check if required parameters exist
    if (!hash || !authDate) {
      console.warn('Missing required parameters in Telegram initData');
      return false;
    }
    
    // Check if auth_date is recent (within 1 hour)
    const authTimestamp = parseInt(authDate);
    const currentTimestamp = Math.floor(Date.now() / 1000);
    if (currentTimestamp - authTimestamp > 3600) { // 1 hour
      console.warn('Telegram auth data is too old');
      return false;
    }
    
    // Remove hash from parameters and sort
    params.delete('hash');
    const sortedParams = Array.from(params.entries()).sort(([a], [b]) => a.localeCompare(b));
    
    // Create data string
    const dataString = sortedParams.map(([key, value]) => `${key}=${value}`).join('\n');
    
    // Create secret key using SHA256
    const encoder = new TextEncoder();
    const secretKey = await crypto.subtle.digest('SHA-256', encoder.encode(botToken));
    
    // Create HMAC-SHA256 hash
    const key = await crypto.subtle.importKey('raw', secretKey, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']);
    const signature = await crypto.subtle.sign('HMAC', key, encoder.encode(dataString));
    
    // Convert signature to hex string
    const hexSignature = Array.from(new Uint8Array(signature))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
    
    // Compare hashes
    const isValid = hexSignature === hash;
    if (!isValid) {
      console.warn('Telegram hash verification failed');
    }
    
    return isValid;
  } catch (error) {
    console.error('Error verifying Telegram data:', error);
    return false;
  }
}
```

#### Server-Side (supabase/functions/telegram-auth/index.ts)

The server-side implementation mirrors the client-side verification and adds additional security measures:

1. **Rate Limiting**: Prevents abuse by limiting authentication requests to 10 per 15 minutes per IP
2. **Enhanced User Profile Management**: Updates user profiles on subsequent logins
3. **Comprehensive Logging**: Tracks authentication attempts, successes, and failures
4. **Error Handling**: Provides detailed error logging for debugging

### 3. Rate Limiting Implementation

To prevent abuse of the authentication endpoint, a rate limiting mechanism has been implemented:

```typescript
interface RateLimitEntry {
  count: number;
  timestamp: number;
}

const rateLimitStore = new Map<string, RateLimitEntry>();

function checkRateLimit(ip: string): boolean {
  const now = Date.now();
  const entry = rateLimitStore.get(ip);
  
  if (!entry) {
    // First request from this IP
    rateLimitStore.set(ip, { count: 1, timestamp: now });
    return true;
  }
  
  // Reset count if more than 15 minutes have passed
  if (now - entry.timestamp > 15 * 60 * 1000) {
    rateLimitStore.set(ip, { count: 1, timestamp: now });
    return true;
  }
  
  // Check if limit exceeded (10 requests per 15 minutes)
  if (entry.count >= 10) {
    return false;
  }
  
  // Increment count
  rateLimitStore.set(ip, { count: entry.count + 1, timestamp: entry.timestamp });
  return true;
}
```

## Environment Variables

The following environment variables are required for proper operation:

- `VITE_TELEGRAM_BOT_TOKEN`: The Telegram bot token used for hash verification
- `TELEGRAM_BOT_TOKEN`: The Telegram bot token used by the Supabase function (server-side)

## Security Best Practices

1. **Keep Bot Tokens Secret**: Never expose bot tokens in client-side code
2. **Regular Monitoring**: Monitor authentication logs for suspicious activity
3. **Update Dependencies**: Keep all dependencies up to date
4. **Validate All Inputs**: Ensure all data received from clients is validated

## Testing

To test the security implementation:

1. Verify that valid Telegram authentication works correctly
2. Test that tampered initData is rejected
3. Confirm that expired auth_date values are rejected
4. Validate that rate limiting works as expected

## Future Enhancements

Potential future security enhancements:

1. **IP-based Blocking**: Implement IP-based blocking for repeated failed attempts
2. **User-based Rate Limiting**: Add rate limiting based on user ID in addition to IP
3. **Enhanced Logging**: Add more detailed analytics for security monitoring
4. **Multi-factor Authentication**: Consider adding additional authentication factors