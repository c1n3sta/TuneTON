<!DOCTYPE html>
<html>
<head>
    <title>Audio Debug Test</title>
</head>
<body>
    <h1>Audio Playback Debug Test</h1>
    
    <div id="testResults"></div>
    
    <button onclick="testAudioPlayback()">Test Audio Playback</button>
    <button onclick="testFreshTrack()">Get Fresh Track</button>
    
    <script>
        let currentTrack = null;
        
        async function testFreshTrack() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<p>Getting fresh track from Jamendo...</p>';
            
            try {
                // Get fresh track from Jamendo via Supabase proxy
                const response = await fetch('https://dthrpvpuzinmevrvqlhv.supabase.co/functions/v1/jamendo-proxy?endpoint=tracks&params=%7B%22limit%22%3A1%7D');
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    currentTrack = data.results[0];
                    const audioUrl = currentTrack.audio || currentTrack.audiodownload;
                    
                    resultsDiv.innerHTML = `
                        <h2>Track Info</h2>
                        <p><strong>Name:</strong> ${currentTrack.name}</p>
                        <p><strong>Artist:</strong> ${currentTrack.artist_name}</p>
                        <p><strong>Duration:</strong> ${currentTrack.duration}s</p>
                        <p><strong>Audio URL:</strong> <a href="${audioUrl}" target="_blank">${audioUrl}</a></p>
                        <p><strong>Time:</strong> ${new Date().toISOString()}</p>
                    `;
                    
                    // Test URL accessibility
                    testUrlAccessibility(audioUrl);
                } else {
                    resultsDiv.innerHTML = '<p style="color: red;">No tracks returned</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error getting track: ${error.message}</p>`;
            }
        }
        
        async function testUrlAccessibility(url) {
            const resultsDiv = document.getElementById('testResults');
            
            try {
                resultsDiv.innerHTML += '<p>Testing URL accessibility...</p>';
                
                // Test HEAD request
                const headResponse = await fetch(url, { method: 'HEAD' });
                resultsDiv.innerHTML += `<p>HEAD Response: ${headResponse.status} ${headResponse.statusText}</p>`;
                
                if (headResponse.ok) {
                    resultsDiv.innerHTML += '<p style="color: green;">URL is accessible</p>';
                } else {
                    resultsDiv.innerHTML += '<p style="color: red;">URL is not accessible</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML += `<p style="color: red;">URL test failed: ${error.message}</p>`;
            }
        }
        
        async function testAudioPlayback() {
            const resultsDiv = document.getElementById('testResults');
            
            if (!currentTrack) {
                resultsDiv.innerHTML = '<p style="color: red;">No track loaded. Click "Get Fresh Track" first.</p>';
                return;
            }
            
            const audioUrl = currentTrack.audio || currentTrack.audiodownload;
            resultsDiv.innerHTML += '<p>Testing audio playback...</p>';
            
            // Create audio element
            const audio = new Audio();
            audio.src = audioUrl;
            
            // Add event listeners
            audio.addEventListener('loadstart', () => {
                resultsDiv.innerHTML += '<p>Load start</p>';
            });
            
            audio.addEventListener('loadeddata', () => {
                resultsDiv.innerHTML += '<p style="color: green;">Loaded data</p>';
            });
            
            audio.addEventListener('canplay', () => {
                resultsDiv.innerHTML += '<p style="color: green;">Can play</p>';
            });
            
            audio.addEventListener('play', () => {
                resultsDiv.innerHTML += '<p style="color: green;">Playing</p>';
            });
            
            audio.addEventListener('error', (e) => {
                resultsDiv.innerHTML += '<p style="color: red;">Audio error</p>';
                console.log('Audio error details:', {
                    code: audio.error?.code,
                    message: audio.error?.message,
                    networkState: audio.networkState,
                    readyState: audio.readyState
                });
            });
            
            // Try to play
            try {
                await audio.play();
                resultsDiv.innerHTML += '<p style="color: green;">Play successful</p>';
            } catch (error) {
                resultsDiv.innerHTML += `<p style="color: red;">Play failed: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>