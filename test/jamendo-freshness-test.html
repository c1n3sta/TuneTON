<!DOCTYPE html>
<html>
<head>
    <title>Jamendo URL Freshness Test</title>
</head>
<body>
    <h1>Jamendo URL Freshness Test</h1>
    
    <button onclick="testFreshUrl()">Get Fresh URL and Test</button>
    <button onclick="testStoredUrl()">Test Stored URL</button>
    
    <br><br>
    
    <div id="results"></div>
    <div id="audioContainer"></div>
    
    <script>
        let currentUrl = "";
        
        async function testFreshUrl() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>Getting fresh track...</p>';
            
            try {
                // Get fresh track from Jamendo via Supabase proxy
                const response = await fetch('https://dthrpvpuzinmevrvqlhv.supabase.co/functions/v1/jamendo-proxy?endpoint=tracks&params=%7B%22limit%22%3A1%7D');
                const data = await response.json();
                
                console.log('Jamendo data:', data);
                
                if (data.results && data.results.length > 0) {
                    const track = data.results[0];
                    const audioUrl = track.audio || track.audiodownload;
                    
                    currentUrl = audioUrl;
                    
                    resultsDiv.innerHTML = `
                        <h2>Track Info</h2>
                        <p><strong>Name:</strong> ${track.name}</p>
                        <p><strong>Artist:</strong> ${track.artist_name}</p>
                        <p><strong>URL:</strong> ${audioUrl}</p>
                        <p><strong>Time:</strong> ${new Date().toISOString()}</p>
                    `;
                    
                    // Test the URL immediately
                    await testUrlAccessibility(audioUrl, "Immediate test");
                } else {
                    resultsDiv.innerHTML = '<p style="color: red;">No tracks returned</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                console.error('Error:', error);
            }
        }
        
        async function testStoredUrl() {
            const resultsDiv = document.getElementById('results');
            
            if (!currentUrl) {
                resultsDiv.innerHTML = '<p style="color: red;">No URL stored. Get a fresh URL first.</p>';
                return;
            }
            
            resultsDiv.innerHTML += '<p>Testing stored URL...</p>';
            await testUrlAccessibility(currentUrl, "Stored URL test");
        }
        
        async function testUrlAccessibility(url, testName) {
            const resultsDiv = document.getElementById('results');
            
            try {
                // Test HEAD request
                const headResponse = await fetch(url, { method: 'HEAD' });
                resultsDiv.innerHTML += `
                    <h3>${testName} - HEAD Request</h3>
                    <p>Status: ${headResponse.status} ${headResponse.statusText}</p>
                `;
                
                if (headResponse.ok) {
                    resultsDiv.innerHTML += '<p style="color: green;">URL is accessible via HEAD</p>';
                    
                    // Create audio element for testing
                    const audioContainer = document.getElementById('audioContainer');
                    audioContainer.innerHTML = `
                        <h3>${testName} - Audio Element Test</h3>
                        <audio id="testAudio" controls src="${url}" style="width: 100%;"></audio>
                        <br><br>
                        <button onclick="playTestAudio()">Play</button>
                        <button onclick="pauseTestAudio()">Pause</button>
                        <div id="audioStatus"></div>
                        <div id="audioError"></div>
                    `;
                    
                    // Add event listeners
                    const audio = document.getElementById('testAudio');
                    const statusDiv = document.getElementById('audioStatus');
                    const errorDiv = document.getElementById('audioError');
                    
                    audio.addEventListener('loadstart', () => {
                        statusDiv.innerHTML += '<p>Load start</p>';
                    });
                    
                    audio.addEventListener('loadeddata', () => {
                        statusDiv.innerHTML += '<p>Loaded data</p>';
                    });
                    
                    audio.addEventListener('canplay', () => {
                        statusDiv.innerHTML += '<p style="color: green;">Can play</p>';
                    });
                    
                    audio.addEventListener('play', () => {
                        statusDiv.innerHTML += '<p style="color: green;">Playing</p>';
                    });
                    
                    audio.addEventListener('error', (e) => {
                        statusDiv.innerHTML += '<p style="color: red;">Error event</p>';
                        errorDiv.innerHTML = `<p style="color: red;">Audio error: ${audio.error ? audio.error.code : 'Unknown'}</p>`;
                        console.log('Audio error details:', audio.error);
                    });
                } else {
                    resultsDiv.innerHTML += '<p style="color: red;">URL is not accessible via HEAD</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML += `<p style="color: red;">${testName} failed: ${error.message}</p>`;
                console.error('Test error:', error);
            }
        }
        
        function playTestAudio() {
            const audio = document.getElementById('testAudio');
            const statusDiv = document.getElementById('audioStatus');
            const errorDiv = document.getElementById('audioError');
            
            statusDiv.innerHTML += '<p>Attempting to play...</p>';
            errorDiv.innerHTML = '';
            
            audio.play().then(() => {
                statusDiv.innerHTML += '<p style="color: green;">Play successful</p>';
            }).catch((error) => {
                statusDiv.innerHTML += `<p style="color: red;">Play failed: ${error.message}</p>`;
                console.log('Play error:', error);
            });
        }
        
        function pauseTestAudio() {
            const audio = document.getElementById('testAudio');
            audio.pause();
            document.getElementById('audioStatus').innerHTML += '<p>Paused</p>';
        }
    </script>
</body>
</html>